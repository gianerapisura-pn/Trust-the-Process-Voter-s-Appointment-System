<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Select Appointment Time - Voter's Appointment System</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
 <header class="header">
    <div class="logo-section">
      <img src="mylogo.png" alt="Logo" class="logo">
      <h1>TRUST THE PROCESS: VOTER'S APPOINTMENT SYSTEM</h1>
    </div>
  </header>
  
  <div class="text-center mt-3">
   <a href="appointment.html" class="nav-btn">
  <i class="fa-solid fa-calendar-days"></i> Schedule an Appointment
  </a>
  <a href="manage_appointment.html" class="nav-btn">
  <i class="fa-regular fa-clock"></i> Manage my Appointment
  </a>
    <a href="requirements.html" class="nav-btn">
  <i class="fa-solid fa-clipboard-list"></i> List of Requirements
  </a>
  </div>

  <div class="form-section">
    <h4><strong>Schedule an Appointment</strong></h4>

    <form id="appointmentForm">
      <div class="row mt-4">
        <div class="col-md-5">
          <label class="form-label">Site <span class="text-danger">*</span></label>
          <select class="form-select mb-4" id="siteSelect" required>
            <option value="">Select a Site</option>
            <option>Quezon City</option>
            <option>Makati City</option>
            <option>Pasig City</option>
          </select>

          <div class="calendar-box">
  <div class="calendar-header">Select a Date</div>
  <input 
    type="date" 
    class="form-control" 
    id="appointmentDate" 
    required
    min="2025-11-23" 
    max="2025-11-29"
  >
  <small class="text-muted d-block mt-2">
    Earliest available appointment: 24 November 2025
  </small>
</div>

        </div>

        <div class="col-md-7">
          <label class="form-label">Select a Time Slot <span class="text-danger">*</span></label>

          <div class="time-slot"><input type="radio" name="time" value="09:30 - 10:30">09:30 - 10:30<span class="available">Available</span></div>
          <div class="time-slot"><input type="radio" name="time" value="10:30 - 11:30">10:30 - 11:30<span class="available">Available</span></div>
          <div class="time-slot"><input type="radio" name="time" value="11:30 - 12:30">11:30 - 12:30<span class="available">Available</span></div>
          <div class="time-slot"><input type="radio" name="time" value="12:30 - 13:30">12:30 - 13:30<span class="available">Available</span></div>
          <div class="time-slot"><input type="radio" name="time" value="13:30 - 14:30">13:30 - 14:30<span class="available">Available</span></div>
          <div class="time-slot"><input type="radio" name="time" value="14:30 - 15:30">14:30 - 15:30<span class="available">Available</span></div>
          <div class="time-slot"><input type="radio" name="time" value="15:30 - 16:30">15:30 - 16:30<span class="available">Available</span></div>
        </div>
      </div>

      <div class="text-center mt-4">
        <a href="site_and_date.html" class="btn-action text-decoration-none d-inline-block text-white">BACK</a>
        <a href="appointment_code.html" class="btn-action text-decoration-none d-inline-block text-white">SUBMIT</a>
        
      </div>
    </form>
  </div>

  <footer>
    <div class="footer-section">
      <div>
        <strong>TRUST THE PROCESS: VOTER'S APPOINTMENT SYSTEM</strong><br>
        123 Mabini Street, Barangay San Isidro, Quezon City, Metro Manila,<br>
        1103, Philippines
      </div>
      <div>
        <strong>CONTACT US</strong><br>
        vas.concerns@ttp.gov.ph<br>
        (02) 1234 - 5678
      </div>
      <div>
        <strong>SITEMAP</strong><br>
        <a href="index.html">HOME</a><br>
        <a href="#">REQUIREMENTS</a><br>
        <a href="appointment.html">SCHEDULE AN APPOINTMENT</a>
      </div>
    </div>
  </footer>
  <script src="api.js"></script>
  <script src="voters.js"></script>
  <script>
  window.addEventListener('DOMContentLoaded', async () => {
    const siteSelect = document.getElementById('siteSelect');

    // Load sites from backend to keep dropdown in sync with DB
    try {
      const sites = await apiFetch('/sites');
      siteSelect.innerHTML = '<option value=\"\">Select a Site</option>' + sites.map(s => `<option value=\"${s.site_id}\" data-name=\"${s.site_name}\" data-address=\"${s.address || ''}\">${s.site_name}</option>`).join('');
    } catch (err) {
      console.error('Failed to load sites', err);
    }

    const storedSiteId = localStorage.getItem('selectedSiteId');
    if (storedSiteId && siteSelect) {
      siteSelect.value = storedSiteId;
    }

    siteSelect.addEventListener('change', () => {
      const opt = siteSelect.options[siteSelect.selectedIndex];
      localStorage.setItem('selectedSiteId', siteSelect.value);
      localStorage.setItem('selectedSiteName', opt ? opt.getAttribute('data-name') : '');
      localStorage.setItem('selectedSiteAddress', opt ? opt.getAttribute('data-address') : '');
    });

    const submitLink = document.querySelector('a[href=\"appointment_code.html\"]');
    if (submitLink) {
      submitLink.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('appointmentForm').dispatchEvent(new Event('submit'));
      });
    }
  });
</script>
<script>
    document.getElementById('appointmentForm').addEventListener('submit', async function(event) {
      event.preventDefault();
      const siteId = document.getElementById('siteSelect').value;
      const siteSelect = document.getElementById('siteSelect');
      const selectedOption = siteSelect.options[siteSelect.selectedIndex];
      const siteName = selectedOption ? selectedOption.getAttribute('data-name') : '';
      const siteAddress = selectedOption ? selectedOption.getAttribute('data-address') : '';
      const date = document.getElementById('appointmentDate').value;
      const time = document.querySelector('input[name="time"]:checked');

      if (!siteId || !date || !time) {
        alert('Please fill out all required fields (Site, Date, and Time Slot) before submitting.');
        return false;
      }

      const personal = JSON.parse(localStorage.getItem('personalInfo') || '{}');
      const contact = {
        gender: localStorage.getItem('gender'),
        nationality: localStorage.getItem('nationality'),
        home_address: localStorage.getItem('address'),
        zip_code: localStorage.getItem('zip'),
        mobile_number: localStorage.getItem('mobile'),
        email_address: localStorage.getItem('email'),
      };

      const [rawStart, rawEnd] = time.value.split('-').map((t) => t.trim());
      const start_time = rawStart.length === 5 ? `${rawStart}:00` : rawStart;
      const end_time = rawEnd.length === 5 ? `${rawEnd}:00` : rawEnd;

      // Save a simple summary for confirmation page fallback
      localStorage.setItem('appointmentSummary', JSON.stringify({
        site_name: siteName,
        site_address: siteAddress,
        slot_date: date,
        time_label: time.value
      }));

      const payload = {
        ...personal,
        ...contact,
        site_id: siteId,
        site_name: siteName,
        site_address: siteAddress,
        slot_date: date,
        start_time,
        end_time,
      };

      if (!payload.first_name || !payload.last_name || !payload.birthday) {
        alert('Missing personal info. Please restart the form.');
        return false;
      }
      if (!payload.gender || !payload.nationality || !payload.home_address || !payload.zip_code || !payload.mobile_number || !payload.email_address) {
        alert('Missing contact info. Please go back and complete the required fields.');
        return false;
      }

      try {
        const response = await submitVoterForm(payload);
        localStorage.setItem('currentVoter', JSON.stringify(response));
        window.location.href = 'appointment_code.html';
      } catch (err) {
        const msg =
          (err.body && (err.body.message || err.body.error)) ||
          (err.message ? err.message : 'Failed to create appointment.');
        alert(msg);
        console.error('submit appointment error', err);
      }
    });
  </script>

</body>
</html>


